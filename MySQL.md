# MySQL

## 数据库概述

### 为什么要用数据库

- 持久化（persistence）：**把数据保存到可掉电式存储设备中以供之后使用**。大多数情况下，特别是企业级应用，**数据持久化意味着将内存中的数据保存到硬盘上加以固化**，而持久化的实现过程大多通过各种关系数据库来完成

- 持久化的主要作用是**将内存中的数据存储在关系型数据库中**，当然也可以存储在磁盘文件、XML 数据文件中

![数据与持久化](img/MySQL_1.png)

### 数据库与数据库管理系统

#### 数据库相关概念

| 术语                                               | 解释                                                                                                                                     |
| -------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| DB：数据库（Database）                             | 即存储数据的“仓库”，其本质是一个文件系统，它保存了一系列有组织的数据。                                                                   |
| DBMS：数据库管理系统（Database Management System） | 是一种操纵和管理数据库的大型软件，用于建立、使用和维护数据库，对数据库进行统一管理和控制。用户通过数据库管理系统访问数据库中表内的数据。 |
| SQL：结构化查询语言（Structured Query Language）   | 专门用来与数据库通讯的语言                                                                                                               |

#### 数据库与数据库管理系统的关系

数据库管理系统(DBMS)可以管理多个数据库，一般开发人员会针对每一个应用创建一个数据库。为了保存应用中实体的数据，一般会在数据库创建多个表，以保存程序中实体用户的数据。

![数据库与数据库管理系统的关系](img/MySQL_2.png)

### MySQL 简介

#### 概述

- MySQL 是一个 **开放源代码的关系型数据库管理系统**

- MySQL 是一种关联数据库管理系统，将数据保存在不同的表中，而不是将所有数据放在一个大仓库内，这样就增加了速度并提高了灵活性。

- MySQL6.x 版本之后分为社区版和商业版。

- MySQL 是开源的，所以不需要支付额外的费用。

- MySQL 是可以定制的，采用了 GPL（GNU General Public License） 协议，你可以修改源码来开发自己的 MySQL 系统。

- MySQL 支持大型的数据库。可以处理拥有上千万条记录的大型数据库。

- MySQL 支持大型数据库，支持 5000 万条记录的数据仓库，32 位系统表文件最大可支持 4GB ，64 位系统支持最大的表文件为 8TB 。

- MySQL 使用 标准的 SQL 数据语言 形式。

- MySQL 可以允许运行于多个系统上，并且支持多种语言。这些编程语言包括 C、C++、Python、Java、Perl、PHP 和 Ruby 等。

#### 关于 MySQL 8.0

MySQL 从 5.7 版本直接跳跃发布了 8.0 版本。MySQL 8 版本在功能上做了显著的改进与增强，开发者对 MySQL 的源代码进行了重构，最突出的一点是多 MySQL Optimizer 优化器进行了改进。不仅在速度上得到了改善，还为用户带来了更好的性能和更棒的体验。

#### 为什么选择 MySQL

1. 开放源代码，使用成本低。
2. 性能卓越，服务稳定。
3. 软件体积小，使用简单，并且易于维护。
4. 历史悠久，社区用户非常活跃，遇到问题可以寻求帮助。
5. 许多互联网公司在用，经过了时间的验证。

#### Oracle VS MySQL

- Oracle 更适合大型跨国企业的使用，因为他们对费用不敏感，但是对性能要求以及安全性有更高的要求。

- MySQL 由于其**体积小、速度快、总体拥有成本低，可处理上千万条记录的大型数据库，尤其是开放源码**这一特点，使得很多互联网公司、中小型网站选择了 MySQL 作为网站数据库（Facebook，Twitter，YouTube，阿里巴巴/蚂蚁金服，去哪儿，美团外卖，腾讯）。

### RDBMS 与 非 RDBMS

关系型数据库是 DBMS 的主流，使用最多的 DBMS 依次是 Oracle、 MySQL、 SQL Server，这些都是关系型数据库（RDBMS）。

#### 关系型数据库(RDBMS)

##### 实质

- 这种类型的数据库是**最古老**的数据库类型，关系型数据库模型是把复杂的数据结构归结为简单的**二元关系**（即二维表格形式）。

- 关系型数据库以 **行(row)** 和 **列(column)** 的形式存储数据，以便于用户理解。这一系列的行和列被称为 **表(table)** ，一组表组成了一个**库(database)**。

- 表与表之间的数据记录有关系(relationship)。现实世界中的各种实体以及实体之间的各种联系均用 **关系模型** 来表示。关系型数据库，就是建立在 **关系模型** 基础上的数据库。

- SQL 就是关系型数据库的查询语言

##### 优点

- **复杂查询** 可以用 SQL 语句方便的在一个表以及多个表之间做非常复杂的数据查询

- **事务支持** 使得对于安全性能很高的数据访问要求得到实现

#### 非关系型数据库(非 RDBMS)

##### 介绍

**非关系型数据库**， 可看成传统关系型数据库的功能 **阉割版本** ，基于键值对存储数据，不需要经过 SQL 层的解析， **性能非常高** 。同时，通过减少不常用的功能，进一步提高了数据库的性能。

目前基本上大部分主流的非关系型数据库都是免费的

##### 类型

- **键值型数据库**

键值型数据库通过 **Key-Value** 键值的方式来存储数据，其中 Key 和 Value 可以是简单的对象，也可以是复杂的对象。Key 作为唯一的标识符，优点是查找速度快，在这方面明显优于关系型数据库，缺点是无法像关系型数据库一样使用条件过滤（比如 WHERE），如果你不知道去哪里找数据，就要遍历所有的键，这就会消耗大量的计算。

键值型数据库典型的使用场景是作为 **内存缓存** 。 **Redis** 是最流行的键值型数据库

![键值型数据库](img/MySQL_3.png)

- **文档型数据库**

此类数据库可存放并获取文档，可以是 XML、JSON 等格式。在数据库中文档作为处理信息的基本单位，一个文档就相当于一条记录。文档数据库所存放的文档，就相当于键值数据库所存放的“值”。MongoDB 是最流行的文档型数据库。此外，还有 CouchDB 等。

- **搜索引擎数据库**

虽然关系型数据库采用了索引提升检索效率，但是针对全文索引效率却较低。搜索引擎数据库是应用在搜索引擎领域的数据存储形式，由于搜索引擎会爬取大量的数据，并以特定的格式进行存储，这样在检索的时候才能保证性能最优。核心原理是“倒排索引”。

典型产品：Solr、Elasticsearch、Splunk 等

- **列式数据库**

列式数据库是相对于行式存储的数据库，Oracle、MySQL、SQL Server 等数据库都是采用的行式存储（Row-based），而列式数据库是将数据按照列存储到数据库中，这样做的好处是可以大量降低系统的 I/O，适合于分布式文件系统，不足在于功能相对有限。典型产品：HBase 等。

- **图形数据库**

图形数据库，利用了图这种数据结构存储了实体（对象）之间的关系。图形数据库最典型的例子就是社交网络中人与人的关系，数据模型主要是以节点和边（关系）来实现，特点在于能高效地解决复杂的关系问题。

图形数据库顾名思义，就是一种存储图形关系的数据库。它利用了图这种数据结构存储了实体（对象）之间的关系。关系型数据用于存储明确关系的数据，但对于复杂关系的数据存储却有些力不从心。如社交网络中人物之间的关系，如果用关系型数据库则非常复杂，用图形数据库将非常简单。

典型产品：Neo4J、InfoGrid 等。

### 关系型数据库设计规则

- 关系型数据库的典型数据结构就是 **数据表** ，这些数据表的组成都是结构化的(Structured)

- 将数据放到表中，表再放到库中。

- 一个数据库中可以有多个表，每个表都有一个名字标记自己，表名具有唯一性

- 表具有一些特征，这些特征定义了数据在表中如何存储，类似 Java 中的 类

#### 表、记录、字段

- E-R（entity-relationship）模型中有三个主要概念：**实体集** 、 **属性** 、 **联系集**

- 一个实体集（class）对应于数据库中的一个表（table），一个实体（instance）则对应于数据库表中的一行（row），也称为一条记录（record）。一个属性（attribute）对应于数据库表中的一列（column），也称为一个字段（field）

![E-R模型主要概念](img/MySQL_4.png)

> ORM 思想 (Object Relational Mapping)体现：
> 数据库中的一个表 <---> Java 或 Python 中的一个类
> 表中的一条数据 <---> 类中的一个对象（或实体）
> 表中的一个列 <----> 类中的一个字段、属性(field)

#### 表的关联关系

- 表与表之间的数据记录有关系(relationship)。现实世界中的各种实体以及实体之间的各种联系均用关系模型来表示。

- 四种：一对一关联、一对多关联、多对多关联、自我引用

##### 一对一关联（one-to-one）

- 在实际的开发中应用不多，因为一对一可以创建成一张表。

- 举例：设计 学生表 ：学号、姓名、手机号码、班级、系别、身份证号码、家庭住址、籍贯、紧急联系人、...

  - 拆为两个表：两个表的记录是一一对应关系。
  - **基础信息表** （常用信息）：学号、姓名、手机号码、班级、系别
  - **档案信息表** （不常用信息）：学号、身份证号码、家庭住址、籍贯、紧急联系人、...

- 两种建表原则：

  - 外键唯一：主表的主键和从表的外键（唯一），形成主外键关系，外键唯一。

  - 外键是主键：主表的主键和从表的主键，形成主外键关系。

##### 一对多关联（one-to-many）

- 常见实例场景： **客户表和订单表**， **分类表和商品表**， **部门表和员工表**

- 举例：

  - 员工表：编号、姓名、...、所属部门
  - 部门表：编号、名称、简介

- 一对多建表原则：在从表（多方）创建一个字段，字段作为外键指向主表（一方）的主键。

##### 多对多关联（many-to-many）

要表示多对多关系，必须创建第三个表，该表通常称为 **联接表** ，它将多对多关系划分为两个一对多关系。将这两个表的主键都插入到第三个表中。

- 举例 1：学生-课程

  - **学生信息表** ：一行代表一个学生的信息（学号、姓名、手机号码、班级、系别...）
  - **课程信息表** ：一行代表一个课程的信息（课程编号、授课老师、简介...）
  - **选课信息表** ：一个学生可以选多门课，一门课可以被多个学生选择

- 举例 2：产品-订单

  “订单”表和“产品”表有一种多对多的关系，这种关系是通过与“订单明细”表建立两个一对多关系来定义的。一个订单可以有多个产品，每个产品可以出现在多个订单中。

  - **产品表** ：“产品”表中的每条记录表示一个产品。
  - **订单表** ：“订单”表中的每条记录表示一个订单。
  - **订单明细表** ：每个产品可以与“订单”表中的多条记录对应，即出现在多个订单中。一个订单可以与“产品”表中的多条记录对应，即包含多个产品。

##### 自我引用（self-reference）

![自我引用](img/MySQL_5.png)

自我引用是指一个表中包含了对自己（表）的引用。

## MySQL 环境搭配

### MySQL 的卸载

1. 停止 MySQL 服务：在任务管理器停止 MySQL 服务。

2. 卸载软件

3. 删除环境变量配置

### MySQL 的 4 大版本

- MySQL Community Server 社区版本，开源免费，自由下载，但不提供官方技术支持，适用于大多数普通用户。
- MySQL Enterprise Edition 企业版本，需付费，不能在线下载，可以试用 30 天。提供了更多的功能和更完备的技术支持，更适合于对数据库的功能和可靠性要求较高的企业客户。
- MySQL Cluster 集群版，开源免费。用于架设集群服务器，可将几个 MySQL Server 封装成一个 Server。需要在社区版或企业版的基础上使用。
- MySQL Cluster CGE 高级集群版，需付费。

### MySQL 的启动、停止服务

使用**管理员身份**运行命令行，输入以下命令：

- 启动 MySQL 服务：`net start mysql`

- 停止 MySQL 服务：`net stop mysql`

## MySQL 的使用

### MySQL 的部分命令

1. 查看数据库列表：`show databases;`

> “information_schema”是 MySQL 系统自带的数据库，主要保存 MySQL 数据库服务器的系统信息，比如数据库的名称、数据表的名称、字段名称、存取权限、数据文件 所在的文件夹和系统使用的文件夹，等等

> “performance_schema”是 MySQL 系统自带的数据库，可以用来监控 MySQL 的各类性能指标。

> “sys”数据库是 MySQL 系统自带的数据库，主要作用是以一种更容易被理解的方式展示 MySQL 数据库服务器的各类性能指标，帮助系统管理员和开发人员监控 MySQL 的技术性能。

> “mysql”数据库保存了 MySQL 数据库服务器运行时需要的系统信息，比如数据文件夹、当前使用的字符集、约束检查信息，等等

2. 创建数据库：`create database 数据库名;`不能和已有的数据库重名

3. 使用自己的数据库：`use 数据库名;`

- 如果没有使用`use`语句，后面针对数据库的操作也没有加“数据名”的限定，则会报错

- 使用完`use`语句后，如果接下来的 SQL 都是针对同一个数据库操作的，那就不用重复 use 了，如果要针对另一个数据库操作，那么需要重新 use

4. 查看某个库的所有表格：`show tables;`

- 前面要先`use`指定的数据库，否则会报错

5. 创建新的表格：

```
create table 表格名 (
    字段名1 数据类型1,
    字段名2 数据类型2,
    字段名3 数据类型3
);
```

- 如果是最后一个字段，后面就不用加逗号，因为逗号的作用是分割每一个字段

6. 查看一个表的数据：`select * from 表格名;`

7. 添加一条记录：`insert into 表名称 values(值列表);`

8. 查看表的创建信息：`show create table 表名称\G`

9. 查看数据库的创建信息：`show create database 数据库名称\G`

10. 删除表：`drop table 表名称;`

11. 删除数据库：`drop database 数据库名称;`

12. 查看当前数据库的端口号：`select @@port;`

### MySQL 目录结构与源码

#### 主要目录结构

| MySQL 的目录结构                               | 说明                                   |
| ---------------------------------------------- | -------------------------------------- |
| /bin                                           | 所有 MySQL 的可执行文件，如：mysql.exe |
| MySQLInstanceConfig.exe                        | 数据库的配置向导，在安装时出现的内容   |
| /data                                          | 系统数据库所在的目录                   |
| my.inl                                         | MySQL 的主要配置文件                   |
| C:\Program Files\MySQL\MySQL Server 8.4\data\  | 用户创建的数据库所在的目录             |

#### MySQL 源代码获取

首先，进入 MySQL 下载界面。不要选择用默认的“Microsoft Windows”，而是要通过下拉栏，找到“Source Code”，在下面的操作系统版本里面， 选择 Windows（Architecture Independent），然后点击下载。

接下来，把下载下来的压缩文件解压，就得到了 MySQL 的源代码。

MySQL 是用 C++ 开发而成的。

mysql-8.0.22 目录下的各个子目录，包含了 MySQL 各部分组件的源代码：

![MySQL 源代码目录结构](img/MySQL_6.png)

- sql 子目录是 MySQL 核心代码；

- libmysql 子目录是客户端程序 API；

- mysql-test 子目录是测试工具；

- mysys 子目录是操作系统相关函数和辅助函数；

## 基本的 SELECT 语句

### SQL 概述

SQL(Structured Query Language，结构化查询语言)是使用关系模型的数据库应用语言，**与数据直接打交道**

SQL 有两个重要标准，分别是 SQL92 和 SQL99。分别代表了 92 年和 99 年颁布的 SQL 标准。

不同的数据生产厂商都支持 SQL 语句，但都有特有内容。

- SQL 规范（普通话）
  - MySQL 特有（方言）
  - Oracle 特有（方言）

#### SQL 分类

SQL 语言在功能上主要分为如下 3 大类：

- **DDL（Data Definition Language，数据定义语言）**，这些语句定义了不同的数据库、表、视图、索引等数据库对象，还可以用来创建、删除、修改数据库和数据表的结构

  - 主要的语句关键字包括`CREATE`、`DROP`、`ALTER`等

- **DML（Data Manipulation Language，数据操纵语言）**，用于添加、删除、更新和查询数据库记录，并检查数据完整性

  - 主要的语句关键字包括`INSERT`、`DELETE`、`UPDATE`、`SELECT`等

  - **SELECT**是 SQL 语言的基础，最为重要。

- **DCL（Data Control Language，数据控制语言）**，用于定义数据库、表、字段、用户的访问权限和安全级别。

  - 主要的雨具关键字包括`GRANT`、`REVOKE`、`COMMIT`、`ROLLBACK`、`SAVEPOINT`等

> 因为查询语句使用得非常频繁，所以很多人把查询语句单拎出来一类：DQL（数据查询语言）。

> 还有单独将`COMMIT`、`ROLLBACK`取出来称为 TCL（Transaction Control Language，事务控制语言）。

### SQL 语言的规则与规范

#### 基本规则

- SQL 语句可以写在一行或者多行。为了提高可读性，各子句分行写，必要时候使用缩进

- 每条命令以`;`或`\g`或`\G`结束

- 关键字不能被缩写也不能分行

- 关于标点符号：

  - 必须保证所有的`()`、单引号、双引号是成对结束的

  - 必须使用英文状态下的半角输入方式

  - 字符串型和日期时间类型的数据可以使用`''`单引号表示

  - 列的别名，尽量使用`""`双引号，而且不建议省略`as`

#### SQL 大小写规范

- **MySQL** 在 Windows 环境下是大小写不敏感的

- **MySQL** 在 Linux 环境下是大小写敏感的

  - 数据库名、表名、表的别名、变量名是严格区分大小写的

  - 关键字、函数名、列名（或字段名）、列的别名（字段的别名）是忽略大小写的

- **推荐采用统一的书写规范**：

  - 数据库名、表名、表的别名、字段名、字段别名等都小写

  - SQL 关键字、函数名、绑定变量都大写

#### SQL 注释

```
单行注释：#注释文字(MySQL特有的方式)
单行注释：-- 注释文字(--后面必须包含一个空格。)
多行注释：/* 注释文字 */
```

#### 命名规则

- 数据库、表名不得超过 30 个字符，变量名限制为 29 个

- 必须只能包含 A–Z, a–z, 0–9, \_共 63 个字符

- 数据库名、表名、字段名等对象名中间不要包含空格

- 同一个 MySQL 软件中，数据库不能同名；同一个库中，表不能重名；同一个表中，字段不能重名必须保证你的字段没有和保留字、数据库系统或常用方法冲突。如果坚持使用，请在 SQL 语句中使用`（着重号）引起来

- 保持字段名和类型的一致性，在命名字段并为其指定数据类型的时候一定要保证一致性。假如数据类型在一个表里是整数，那在另一个表里可就别变成字符型了

#### 数据导入指令

启动 MySQL 命令行客户端，使用`source`指令录入以`.sql`结尾的文件路径：

```
mysql> SOURCE 文件名;
```

### 基本的 SELECT 语句

#### SELECT ... FROM

- 语法：`SELECT 标识选择哪些列 FROM 标识从哪个表中选择`

- 选择所有列：`SELECT * FROM 表名;`

  使用通配符`*`代表将所有列都选择，在生产环境不建议直接使用

- 选择特定列：`SELECT 列1, 列2, 列3 FROM 表名;`

#### 列的别名

- 重命名一个列

- 便于计算

- 紧跟列名，也可以**在列名和别名之间加入关键字 AS，别名使用双引号**，以便在别名中包含空格或特殊字符并区分大小写。

- AS 可以省略

- 别名建议简短，见名知意

```
SELECT 列名1 AS 列名1别名, 列名2 列名2别名
FROM 表名;
```

#### 去除重复行

默认情况查询会返回全部行，包括重复行。

在 SELECT 语句中使用关键字`DISTINCT`去除重复行

```
SELECT DISTINCT 列名 FROM 表名;
```

注意：

1. DISTINCT 需要放到所有列名的前面

2. DISTINCT 其实是对后面所有列名的组合进行去重

#### 空值参与运算

- 所有运算符或列值遇到null值，运算的结果都为null

- 在MySQL中，空值不等于空字符串